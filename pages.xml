<?xml version="1.0" encoding="UTF-8" ?>
<site>

	<!-- model forms -->
	{{ model.makeform('#view',       'GET', '/re/_design/$1/_view/$2?$3') }}
	{{ model.makeform('#view-eq', 	 'GET', '/re/_design/$1/_view/$2?keys=["$3"]&include_docs=true') }}
	{{ model.makeform('#view-range', 'GET', '/re/_design/$1/_view/$2?startkey=["$3",{}]&endkey=["$3"]&descending=true&include_docs=true') }}
	{{ model.makeform('#git-env',    'GET', '/rexpress/environments/raw/master/$1', baseurl='https://github.com/', immutable=True) }}



	<!-- global vars -->
	{% set news		  = model.form('#view', 'share', 'news', 'include_docs=true&descending=true') %}
	{% set tags		  = model.form('#view', 'tag',	 'tags', 'group_level=1') %}
	{% set env_groups = model.form('#view', 'env',	 'envs', 'group_level=1') %}

	{# set env_groups = sorted(env_groups, key=lambda doc: doc.value.max) #}

	<!-- set env infos -->
	{% set env_group_info = dict() %}

	{% for eg in env_groups.rows %}
		{% set env = eg.key[0] %}

		{% set _tmp = env_group_info.update({ env : {
			'env'     : env,
			'info'    : model.form('#git-env', env + '/_info.json'),
			'shares'  : model.form('#view-range', 'env', 'shares', env).rows,
			'children': model.form('#view', 'env', 'envs', 'group_level=2&startkey=["'+env+'"]&endkey=["'+env+'",{}]').rows,
		} }) %}

	{% endfor %}


	<!-- render home -->
	<page>
		<url>/</url>
		<context type="json">
			{
				"news": [
					{% for env, data in env_group_info.items() %}
						{
							"env": "{{ env }}",
							"data": {{ json.dumps(data.shares) }}
						}
						{% if not loop.last %},{% endif %}
					{% endfor %}
				],
				"tags": {{ json.dumps(tags) }}
			}
		</context>
		<template>home.html</template>
	</page>



	<!-- render env_group(level=1) -->
	{% for eg in env_groups.rows %}
	{% set env = eg.key[0] %}
	<page>
		<url>/env/{{ env }}</url>
		<context>
			{{ env_group_info[ env ] }}
		</context>
		<template>list_env_group.html</template>
	</page>
	{% endfor %}


	<!-- render tags -->
	{% for tag in tags.rows %}
	<page>
		<url>/tag/{{ tag.key }}</url>
		<context>
			{{ dict(
				tag 	= tag.key,
				shares 	= model.form('#view-range', 'tag', 'shares', tag.key).rows,
			) }}
		</context>
		<template>list_tag.html</template>
	</page>
	{% endfor %}


	<!-- get all share docs -->
	{% set all_shares = model.post('/re/_find', {
		'selector': {
			'_id': { '$gt': 0 },
			'type': { '$eq': 'share' }
		},
		'fields': ['_id', '_rev'],
		'sort': [{ '_id': 'desc' }]
	}) %}

	<!-- render shares -->
	{% for doc in all_shares.docs %}
	<page>
		<url>/share/{{ doc._id }}/</url>
		<context>
			{{
				model.get(
					api = '/re/_design/share/_view/share?keys=["' + doc._id +'"]&include_docs=true',
					immutable = True
				)
			}}
		</context>
		<template>share_view.html</template>
	</page>
	{% endfor %}


	<!-- render static pages -->
	<page>
		<url>/doc/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/env/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/down/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/tag/</url>
		<template>under_cons.html</template>
	</page>
</site>
