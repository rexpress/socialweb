<?xml version="1.0" encoding="UTF-8" ?>
<site>
	{% set news = model.get('/re/_design/share/_view/news?include_docs=true&descending=true') %}
	{% set tags = model.get('/re/_design/tag/_view/tags?group_level=1') %}
	{% set env_group = model.get('/re/_design/env/_view/envs?group_level=1') %}

	<!-- render home -->
	<page>
		<url>/</url>
		<context type="json">
			{
				"news": [
					{% for eg in env_group.rows %}
						{% set env = eg.key[0] %}
						{
							"env": "{{ env }}",
							"data": {{ json.dumps(
								model.get('/re/_design/env/_view/shares?startkey=["'+env+'",{}]&endkey=["'+env+'"]&descending=true&include_docs=true').rows
							) }}
						}
						{% if not loop.last %},{% endif %}
					{% endfor %}
				],
				"tags": {{ json.dumps(tags) }}
			}
		</context>
		<template>home.html</template>
	</page>



	<!-- render shares -->
	{% set all_docs = model.post('/re/_find', {
		'selector': {
			'_id': { '$gt': 0 },
			'type': { '$eq': 'share' }
		},
		'fields': ['_id', '_rev'],
		'sort': [{ '_id': 'desc' }]
	}) %}

	{% for doc in all_docs.docs %}
	<page>
		<url>/share/{{ doc._id }}/</url>
		<context>
			{{
				model.get(
					api = '/re/_design/share/_view/share?keys=["' + doc._id +'"]&include_docs=true',
					immutable = True
				)
			}}
		</context>
		<template>share_view.html</template>
	</page>
	{% endfor %}


	<!-- render env_group(level=1) -->
	{% for eg in env_group.rows %}
	{% set env = eg.key[0] %}
	<page>
		<url>/env/{{ env }}</url>
		<context>
			{{ dict(
				env 	= env,
				shares	= model.get('/re/_design/env/_view/shares?startkey=["'+env+'",{}]&endkey=["'+env+'"]&descending=true&include_docs=true').rows,
			) }}
		</context>
		<template>env_group.html</template>
	</page>
	{% endfor %}


	<!-- render tags -->
	{% for tag in tags.rows %}
	<page>
		<url>/tag/{{ tag.key }}</url>
		<context>
			{{ dict(
				tag 	= tag.key,
				shares 	= model.get('/re/_design/tag/_view/shares?startkey=["'+tag.key+'",""]&endkey=["'+tag.key+'"]&descending=true&include_docs=true').rows,
			) }}
		</context>
		<template>tag.html</template>
	</page>
	{% endfor %}


	<!-- render static pages -->
	<page>
		<url>/doc/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/env/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/down/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/tag/</url>
		<template>under_cons.html</template>
	</page>
</site>
