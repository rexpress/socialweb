<?xml version="1.0" encoding="UTF-8" ?>
<site>
	{{ ext.customize_model(model) }}


	<!-- global vars -->
	{% set tags = model.macro('#view', 'tag', 'tags', 'group_level=1') %}
	{% set envs = ext.get_envs(model) %}

	{# set env_groups = sorted(env_groups, key=lambda doc: doc.value.max) #}

	<!-- render home -->
	<page>
		<url>/</url>
		<context type="json">
			{
				"news": [
					{% for env, data in envs.items() %}
						{
							"env": "{{ env }}",
							"data": {{ json.dumps(data.shares) }}
						}
						{% if not loop.last %},{% endif %}
					{% endfor %}
				],
				"tags": {{ json.dumps(tags) }}
			}
		</context>
		<template>home.html</template>
	</page>



	<!-- render env page-->
	<page>
		<url>/env/</url>
		<context>{{ {'envs': envs} }}</context>
		<template>env_summary.html</template>
	</page>


	<!-- render env_group(level=1) -->
	{% for env_group, data in envs.items() %}
	<page>
		<url>/env/{{ env_group }}/</url>
		<context>{{ data }}</context>
		<template>list_env_group.html</template>
	</page>

		<!-- env_child(level=2) -->
		{% for env_child, data2 in data.children.items() %}
			<page>
				<url>/env/{{ env_group }}/{{ env_child }}/</url>
				<context>{{ data2 }}</context>
				<template>list_env_child.html</template>
			</page>
		{% endfor %}
	{% endfor %}



	<!-- render tags -->
	{% for tag in tags.rows %}
	<page>
		<url>/tag/{{ tag.key }}/</url>
		<context>
			{{ dict(
				tag 	= tag.key,
				shares 	= model.macro('#view-range', 'tag', 'shares', tag.key).rows,
			) }}
		</context>
		<template>list_tag.html</template>
	</page>
	{% endfor %}


	<!-- get all share docs -->
	{% set all_shares = model.post('/re/_find', {
		'selector': {
			'_id': { '$gt': 0 },
			'type': { '$eq': 'share' }
		},
		'fields': ['_id', '_rev'],
		'sort': [{ '_id': 'desc' }]
	}) %}

	<!-- render shares -->
	{% for doc in all_shares.docs %}
	{% set tmp = model.macro('#view-eq-im', 'share', 'share', doc._id) %}
	{% set doc2 = tmp.rows[0].doc %}

	<page>
		<url>/share/{{ doc._id }}/</url>
		<context>
			{{ {
				'doc'    : doc2,
				'author' : tmp.rows[1].doc,
				'env'    : envs[ doc2.env[0] ]['children'][ doc2.env[1] ]
			} }}
		</context>
		<template>share_view.html</template>
	</page>
	{% endfor %}




	<!-- render static pages -->
	<page>
		<url>/doc/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/down/</url>
		<template>under_cons.html</template>
	</page>
	<page>
		<url>/tag/</url>
		<template>under_cons.html</template>
	</page>
</site>
